<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¸–ç•Œç­¾è¯æ”¿ç­–æŸ¥è¯¢åŠæŠ¤ç…§æ’è¡Œæ¦œ</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/picocss/1.5.13/pico.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />

  <style>
    body { padding: 20px; }
    main.container { max-width: 800px; margin: 0 auto; }
    header { text-align: center; }

    /* ç­¾è¯æŸ¥è¯¢æ ·å¼ */
    .autoComplete_wrapper { display:block; margin:0 auto; max-width:350px; }
    #country-search { width: 100%; padding: 1rem 2rem; box-sizing: border-box; }
    #result-card { display: none; margin-top: 1.2rem; }

    /* æ’è¡Œæ¦œæ ·å¼ */
    hr { margin: 3rem 0; }
    .controls { display:grid; grid-template-columns:1fr; gap:1.2rem; margin-bottom:1.5rem; border:1px solid #e0e0e0; padding:1rem; border-radius:8px; }
    .controls-row { display:flex; flex-wrap:wrap; gap:1rem; align-items:center; }
    .view-controls-group { display:flex; gap:1rem; align-items:center; }
    #rank-table th, #rank-table td { text-align:center; }
    #rank-table .name { text-align:left; }
    .sortable { cursor:pointer; position:relative; user-select:none; }
    .sortable::after { content:''; position:absolute; right:8px; top:50%; transform:translateY(-50%); border:5px solid transparent; opacity:0.3; }
    .sortable.asc::after { border-bottom-color:var(--primary,currentColor); margin-top:-2px; opacity:1; }
    .sortable.desc::after { border-top-color:var(--primary,currentColor); margin-top:2px; opacity:1; }
    tr.highlight { background-color:#fffbe6 !important; }
    tr.highlight td.name { font-weight:bold; }
    .search-input {
  background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZvY3VzYWJsZT0iZmFsc2UiIHg9IjBweCIgeT0iMHB4IiB3aWR0aD0iMzAiIGhlaWdodD0iMzAiIHZpZXdCb3g9IjAgMCAxNzEgMTcxIiBzdHlsZT0iIGZpbGw6IzAwMDAwMDsiPjx nIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0ibm9uemVybyIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIHN0cm9rZS1saW5lY2FwPSJidXR0IiBzdHJva2UtbGluZWpvaW49Im1pdGVyIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHN0cm9rZS1kYXNoYXJyYXk9IiIgc3Ryb2tlLWRhc2h vZmZzZXQ9IjAiIGZvbnQtZmFtaWx5PSJub25lIiBmb250LXdlaWdodD0ibm9uZSIgZm9udC1zaXplPSJub25lIiB0ZXh0LWFuY2hvcj0ibm9uZSIgc3R5bGU9Im1peC1ibGVuZC1tb2RlOiBub3JtYWwiPjxwYXRoIGQ9Ik0wLDE3MS45OTYwOXYtMTcxLjk5NjA5aDE3MS45OTYwOXYxNzEuOTk2MDl6IiBmaWxsPSJub25lIj48L3BhdGg+PGcgZmlsbD0iI2ZmN2E3YSI+PHBhdGggZD0iTTc0LjEsMTcuMWMtMzEuNDEyNzIsMCAtNTcsMjUuNTg3MjggLTU3LDU3YzAsMzEuNDEyNzIgMjUuNTg3MjgsNTcgNTcsNTdjMTMuNjYwMSwwIDI2LjIwNTA5LC00Ljg1MDc4IDM2LjAzNjkyLC0xMi45MDI5M2wzNC4wMzMwMSwzNC4wMzMwMWMxLjQyOTY1LDEuNDg5MDcgMy41NTI2MiwyLjA4ODkxIDUuNTUwMTQsMS41NjgxOGMxLjk5NzUyLC0wLjUyMDczIDMuNTU3NDYsLTIuMDgwNjcgNC4wNzgxOSwtNC4wNzgxOWMwLjUyMDczLC0xLjk5NzUyIC0wLjA3OTEzLC00LjEyMDQ5IC0xLjU2ODE4LC01LjU1MDE0bC0zNC4wMzMwMSwtMzQuMDMzMDFjOC4wNTIxNSwtOS44MzE4MiAxMi45MDI5MywtMjIuMzc2ODIgMTIuOTAyOTMsLTM2LjAzNjkyYzAsLTMxLjQxMjcyIC0yNS41ODcyOCwtNTcgLTU3LC01N3pNNzQuMSwyOC41YzI1LjI1MTcsMCA0NS42LDIwLjM0ODMgNDUuNiw0NS42YzAsMjUuMjUxNyAtMjAuMzQ4Myw0NS42IC00NS42LDQ1LjZjLTI1LjI1MTcsMCAtNDUuNiwtMjAuMzQ4MyAtNDUuNiwtNDUuNmMwLC0yNS4yNTE3IDIwLjM0ODMsLTQ1LjYgNDUuNiwtNDUuNnoiPjwvcGF0aD48L2c+PC9nPjwvc3ZnPg==");
  background-repeat: no-repeat;
  background-size: 22px;
  background-position: 10px center;
  padding-left: 40px; /* ç»™æ–‡å­—ç•™å‡ºå›¾æ ‡ç©ºé—´ */
}
.awesomplete ul {
  list-style: none !important;   /* å»æ‰é»˜è®¤åœ†ç‚¹ */
  padding-left: 0 !important;    /* å»æ‰å·¦ç¼©è¿› */
  margin: 0;                     /* ä¿æŒç´§å‡‘ */
}
/* --- å“åº”å¼è¡¨æ ¼æ ·å¼ (æ‰‹æœºç«¯ä¼˜åŒ–) --- */
        @media (max-width: 576px) {
	        .autoComplete_wrapper {
    margin: 0 50px;
}
            body {
                padding: 10px; /* åœ¨å°å±å¹•ä¸Šå‡å°‘é¡µé¢è¾¹è· */
            }
            main.container {
                padding: 0 5px; /* å‡å°‘å®¹å™¨çš„å†…è¾¹è· */
            }
            #rank-table {
                font-size: 0.875rem; /* é€‚å½“ç¼©å°è¡¨æ ¼å­—ä½“ */
                table-layout: fixed; /* å›ºå®šè¡¨æ ¼å¸ƒå±€ï¼Œè®©å®½åº¦è®¾ç½®ç”Ÿæ•ˆ */
                width: 100%;       /* è¡¨æ ¼å®½åº¦å æ»¡å®¹å™¨ */
            }
            #rank-table th, #rank-table td {
                padding: 0.75rem 0.3rem; /* å‡å°å•å…ƒæ ¼çš„æ°´å¹³å’Œå‚ç›´å†…è¾¹è·ï¼Œè®©å†…å®¹æ›´ç´§å‡‘ */
                word-wrap: break-word; /* å…è®¸é•¿å•è¯æ¢è¡Œ */
            }
            /* --- â†“â†“â†“ å°†ä¸‹é¢çš„ä»£ç å¤åˆ¶åˆ°è¿™é‡Œ â†“â†“â†“ --- */
            #rank-table .rank { width: 10%; }
            #rank-table .name { width: 40%; }
            #rank-table .score,
            #rank-table .free,
            #rank-table .evisa,
            #rank-table .visa { width: 12.5%; }
            /* --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ --- */
        }
  </style>
</head>
<body>
  <main class="container">
    <!-- ç­¾è¯æŸ¥è¯¢ -->
    <section id="checker-section">
      <header>
        <h1 style="margin-bottom:0;">ğŸŒ ç­¾è¯æ”¿ç­–é€ŸæŸ¥</h1>
        <p>è¾“å…¥è¦æŸ¥è¯¢çš„ç›®çš„åœ°çš„ä¸­æ–‡ã€è‹±æ–‡æˆ–æ‹¼éŸ³é¦–å­—æ¯</p>
      </header>

      <div class="autoComplete_wrapper">
        <input id="country-search" type="text" placeholder="ä¾‹å¦‚ï¼šæ³°å›½ / Thailand / TG" class="search-input" />
      </div>

      <article id="result-card" aria-live="polite">
        <h4 id="result-country"></h4>
        <p id="result-policy" style="font-size:1.05rem; margin:0"></p>
      </article>
    </section>

    <hr />

    <!-- æŠ¤ç…§æ’è¡Œæ¦œ -->
    <section id="rank-section">
      <header><h1>ğŸ† å›½å®¶æˆ–åœ°åŒºæŠ¤ç…§å®åŠ›æ’è¡Œæ¦œ</h1></header>

      <div class="controls">
        <div class="controls-row">
          <span>æ˜¾ç¤ºåˆ—:</span>
          <div class="view-controls-group">
            <label><input type="checkbox" role="switch" data-toggle="free" checked> å…ç­¾</label>
            <label><input type="checkbox" role="switch" data-toggle="evisa" checked> ç”µå­ç­¾</label>
            <label><input type="checkbox" role="switch" data-toggle="visa" checked> éœ€ç­¾è¯</label>
          </div>
        </div>

        <div class="controls-row">
          <span>å¿«é€Ÿè·³è½¬:</span>
          <input type="search" id="rank-search" placeholder="è¾“å…¥å›½å®¶/åœ°åŒºåç§°..." />
        </div>
      </div>

      <figure>
        <table id="rank-table" role="grid">
          <thead>
            <tr>
              <th class="rank">#</th>
              <th class="name">å›½å®¶/åœ°åŒº</th>
              <th class="score sortable" data-sort="score">æ€»åˆ†</th>
              <th class="free sortable" data-sort="free">å…ç­¾</th>
              <th class="evisa sortable" data-sort="evisa">ç”µå­ç­¾</th>
              <th class="visa sortable" data-sort="visa">éœ€ç­¾è¯</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </figure>
    </section>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>

  <script>
  (function(){
    const input = document.getElementById('country-search');
    const resultCard = document.getElementById('result-card');
    const resultCountry = document.getElementById('result-country');
    const resultPolicy = document.getElementById('result-policy');

    // ç¼“å­˜æœ€åä¸€æ¬¡ä»åç«¯å–å¾—çš„å»ºè®®æ•°ç»„ [{chn,eng,poli},...]
    let lastSuggestions = [];

    function displayResult(item){
      if(!item) return;
      resultCountry.textContent = `${item.chn} (${item.eng})`;
      resultPolicy.textContent = `ç­¾è¯æ”¿ç­–ï¼š${item.poli}`;
      resultCard.style.display = 'block';
    }

    // åˆå§‹åŒ– Awesomplete
    const aw = new Awesomplete(input, {
      minChars: 1,
      maxItems: 12,
      autoFirst: false,
      // è®©æˆ‘ä»¬ä¼ å…¥å­—ç¬¦ä¸² "chn|||eng"ï¼Œå¹¶åœ¨ item/replace ä¸­è§£ææ˜¾ç¤º/æ›¿æ¢
      item: function(text, inputText) {
        // text æ˜¯æˆ‘ä»¬æ”¾å…¥ list çš„å­—ç¬¦ä¸²
        const parts = text.split('|||');
        const chn = parts[0] || '';
        const eng = parts[1] || '';
        const li = document.createElement('li');
        li.innerHTML = `<span>${escapeHtml(chn)}</span> <small style="color:#888;margin-left:8px">${escapeHtml(eng)}</small>`;
        li.setAttribute('data-value', text);
        return li;
      },
      replace: function(text) {
        // text æ˜¯æˆ‘ä»¬æ”¾å…¥ list çš„å­—ç¬¦ä¸²ï¼›ç”¨ä¸­æ–‡åæ›¿æ¢è¾“å…¥æ¡†
        const chn = (text.split('|||')[0]) || text;
        this.input.value = chn;
      }
    });

    // å·¥å…·ï¼šé˜² XSS æ˜¾ç¤º
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
    }

    // å½“ç”¨æˆ·è¾“å…¥æ—¶å»åç«¯æ‹¿å»ºè®®å¹¶æ›´æ–° Awesomplete åˆ—è¡¨
    let controller = null;
    input.addEventListener('input', async (e) => {
      const q = input.value.trim();
      // éšè—æ—§ç»“æœï¼Œç­‰å¾…æ–°çš„é€‰æ‹©
      resultCard.style.display = 'none';

      if(controller){ controller.abort(); controller = null; }
      if(!q) { aw.list = []; lastSuggestions = []; return; }

      try {
        controller = new AbortController();
        const res = await fetch(`/api/search?term=${encodeURIComponent(q)}`, { signal: controller.signal });
        const data = await res.json();
        if (!Array.isArray(data)) { lastSuggestions = []; aw.list = []; return; }

        // ç¼“å­˜
        lastSuggestions = data.slice(0, 50); // ç¼“ä¸€ç‚¹
        // æŠŠå€™é€‰è½¬æˆå­—ç¬¦ä¸² "chn|||eng"ï¼Œawesomplete æ˜¾ç¤º chn + eng
        aw.list = lastSuggestions.map(x => `${x.chn}|||${x.eng}`);
        controller = null;
      } catch(err) {
        if(err.name === 'AbortError') return;
        console.error('fetch suggestions failed', err);
        lastSuggestions = [];
        aw.list = [];
      }
    });

    // å½“ Awesomplete è§¦å‘é€‰æ‹©å®Œæˆï¼ˆé¼ æ ‡ç‚¹å‡»æˆ–é”®ç›˜é€‰æ‹©å›è½¦ï¼‰æ—¶
    input.addEventListener('awesomplete-selectcomplete', function(evt){
      // evt.text.value æ˜¯æˆ‘ä»¬åˆ—è¡¨çš„å­—ç¬¦ä¸² "chn|||eng"
      const raw = evt.text.value || '';
      const chn = raw.split('|||')[0] || raw;
      // è¾“å…¥æ¡†å·²è¢« replace è®¾ç½®ä¸ºä¸­æ–‡åï¼Œä½†æˆ‘ä»¬å†ä½¿ç”¨ç¼“å­˜ç²¾ç¡®åŒ¹é…æ˜¾ç¤ºå®Œæ•´è®°å½•
      const match = lastSuggestions.find(x => x.chn === chn || x.eng === chn);
      if(match){
        displayResult(match);
        return;
      }
      // å…œåº•ï¼šå‘è¯·æ±‚è·å–ä»¥ä¸­æ–‡åæŸ¥è¯¢çš„ç¬¬ä¸€ä¸ªç»“æœ
      (async () => {
        try{
          const r = await fetch(`/api/search?term=${encodeURIComponent(chn)}`);
          const arr = await r.json();
          if(Array.isArray(arr) && arr.length) displayResult(arr[0]);
        }catch(e){ console.error('fallback fetch failed', e); }
      })();
    });

    // å›è½¦å¤„ç†ï¼šå»¶åæ‰§è¡Œï¼Œä¼˜å…ˆè®© awesomplete çš„é€‰æ‹©å…ˆè¿è¡Œï¼ˆå¦‚æœæ˜¯é€šè¿‡ä¸Šä¸‹é”® + å›è½¦é€‰æ‹©ï¼‰
    input.addEventListener('keydown', function(ev){
      if(ev.key === 'Enter'){
        ev.preventDefault();
        setTimeout(async () => {
          // å¦‚æœå·²ç»æ˜¾ç¤ºäº†ç»“æœï¼ˆè¯´æ˜ awesomplete å·²å¤„ç†é€‰æ‹©ï¼‰ï¼Œåˆ™ä¸è¦è¦†ç›–
          if(resultCard.style.display === 'block') return;
          const q = input.value.trim();
          if(!q) return;
          // ä¼˜å…ˆåœ¨ç¼“å­˜ä¸­ç²¾ç¡®åŒ¹é…
          const match = lastSuggestions.find(x => x.chn === q || x.eng === q);
          if(match){ displayResult(match); return; }

          // å›é€€ï¼šè¯·æ±‚åç«¯ï¼Œæ˜¾ç¤ºç¬¬ä¸€ä¸ªåŒ¹é…
          try{
            const r = await fetch(`/search?term=${encodeURIComponent(q)}`);
            const arr = await r.json();
            if(Array.isArray(arr) && arr.length) displayResult(arr[0]);
          }catch(e){ console.error('enter fallback fetch failed', e); }
        }, 0);
      }
    });

    // å…¼å®¹é¼ æ ‡ç›´æ¥ç‚¹å‡»å€™é€‰ä½†æœªè§¦å‘ selectcompleteï¼ˆæå°‘è§ï¼‰ï¼šç›‘å¬ document click å»¶ååŒ¹é…
    document.addEventListener('click', function(){
      setTimeout(() => {
        const q = input.value.trim();
        if(!q) return;
        const match = lastSuggestions.find(x => x.chn === q || x.eng === q);
        if(match) displayResult(match);
      }, 0);
    });

    // ========== æŠ¤ç…§æ’è¡Œæ¦œï¼ˆä¿æŒåŸé€»è¾‘ï¼‰ ==========
    document.addEventListener('DOMContentLoaded', () => {
      const tableBody = document.querySelector("#rank-table tbody");
      const tableHead = document.querySelector("#rank-table thead");
      const viewControls = document.querySelector(".view-controls-group");
      const rankTable = document.getElementById("rank-table");
      const rankSearchInput = document.getElementById("rank-search");

      let originalData = [];
      let currentSort = { key: "score", direction: "desc" };

      function renderTable(data){
        tableBody.innerHTML = "";
        data.forEach((country, i) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="rank">${i+1}</td>
            <td class="name">${escapeHtml(country.name)}</td>
            <td class="score">${country.score}</td>
            <td class="free">${country.free}</td>
            <td class="evisa">${country.evisa}</td>
            <td class="visa">${country.visa}</td>
          `;
          tableBody.appendChild(row);
        });
      }

      function sortAndRender(){
        const { key, direction } = currentSort;
        const sorted = [...originalData].sort((a,b) => direction === 'asc' ? a[key] - b[key] : b[key] - a[key]);
        renderTable(sorted);
        tableHead.querySelectorAll('th.sortable').forEach(th => {
          th.classList.remove('asc','desc');
          if(th.dataset.sort === key) th.classList.add(direction);
        });
      }

      fetch('/api/rankings').then(r => r.json()).then(data => {
        originalData = data;
        sortAndRender();
      }).catch(err => console.error('rankings fetch failed', err));

      tableHead.addEventListener('click', (e) => {
        const th = e.target.closest('th.sortable');
        if(!th) return;
        const key = th.dataset.sort;
        currentSort = { key, direction: currentSort.key === key && currentSort.direction === 'desc' ? 'asc' : 'desc' };
        sortAndRender();
      });

      rankSearchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase().trim();
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(r => r.classList.remove('highlight'));
        if(!term) return;
        for(const row of rows){
          const name = row.querySelector('.name').textContent.toLowerCase();
          if(name.includes(term)){
            row.scrollIntoView({ behavior:'smooth', block:'center' });
            row.classList.add('highlight');
            break;
          }
        }
      });

      viewControls.addEventListener('change', (e) => {
        if(e.target.type === 'checkbox'){
          const col = e.target.dataset.toggle;
          rankTable.style.setProperty(`--display-${col}`, e.target.checked ? 'table-cell' : 'none');
        }
      });

      ['free','evisa','visa'].forEach(col => rankTable.style.setProperty(`--display-${col}`, 'table-cell'));
      const styleSheet = document.createElement('style');
      styleSheet.innerText = `
        #rank-table .free { display: var(--display-free); }
        #rank-table .evisa { display: var(--display-evisa); }
        #rank-table .visa { display: var(--display-visa); }
      `;
      document.head.appendChild(styleSheet);

      // æœ¬é¡µé¢å†…ä¹Ÿå¯ç”¨ escapeHtml
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }
    });
  })();
  </script>
</body>
</html>


